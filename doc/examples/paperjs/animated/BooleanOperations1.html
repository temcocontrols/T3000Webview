<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Operations with Paper.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        canvas {
            border: 1px solid black;
            width: 80vw;
            height: 70vh;
        }
        #log {
            width: 80vw;
            height: 20vh;
            border: 1px solid black;
            overflow-y: scroll;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="file" id="fileInput1" accept=".svg">
        <input type="file" id="fileInput2" accept=".svg">
        <textarea id="svgString1" placeholder="Paste SVG string here..."></textarea>
        <textarea id="svgString2" placeholder="Paste SVG string here..."></textarea>
        <button id="unionButton">Union</button>
        <button id="differenceButton">Difference</button>
        <button id="xorButton">XOR</button>
        <button id="intersectionButton">Intersection</button>
        <button id="clearButton">Clear</button>
    </div>
    <canvas id="myCanvas"></canvas>
    <div id="log"></div>
    <script>
        paper.setup('myCanvas');

        let shapes = [];

        // Function to log details
        const logDetails = (message) => {
            const log = document.getElementById('log');
            log.innerHTML += `<p>${message}</p>`;
            log.scrollTop = log.scrollHeight;
        };

        // Function to load SVG from FileReader
        const loadSVGFromFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const svgContent = e.target.result;
                    paper.project.importSVG(svgContent, item => {

                        resolve({ item, svgContent });
                    });
                };
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        };

        // Function to load SVG from string
        const loadSVGFromString = (svgContent) => {
            return new Promise((resolve) => {
                paper.project.importSVG(svgContent, item => {
                    resolve({ item, svgContent });
                });
            });
        };

        // Function to extract paths from SVG item
        const extractPaths = (item) => {
            let paths = [];
            if (item instanceof paper.Path || item instanceof paper.CompoundPath) {
                paths.push(item);
            } else if (item.children) {
                item.children.forEach(child => {
                    paths = paths.concat(extractPaths(child));
                });
            }
            return paths;
        };

        // Function to perform boolean operations
        const performBooleanOperation = (operation) => async () => {
            const fileInput1 = document.getElementById('fileInput1').files[0];
            const fileInput2 = document.getElementById('fileInput2').files[0];
            const svgString1 = document.getElementById('svgString1').value;
            const svgString2 = document.getElementById('svgString2').value;

            try {
                let svgItem1, svgContent1, svgItem2, svgContent2;

                if (fileInput1) {
                    const result = await loadSVGFromFile(fileInput1);
                    svgItem1 = result.item;
                    svgContent1 = result.svgContent;
                } else if (svgString1) {
                    const result = await loadSVGFromString(svgString1);
                    svgItem1 = result.item;
                    svgContent1 = result.svgContent;
                }

                if (fileInput2) {
                    const result = await loadSVGFromFile(fileInput2);
                    svgItem2 = result.item;
                    svgContent2 = result.svgContent;
                } else if (svgString2) {
                    const result = await loadSVGFromString(svgString2);
                    svgItem2 = result.item;
                    svgContent2 = result.svgContent;
                }

                if (svgItem1 && svgItem2) {
                    logDetails(`Loaded SVG1: ${svgContent1}`);
                    logDetails(`Loaded SVG2: ${svgContent2}`);

                    //test to set the same properties as T3000 user selected
                    svgItem1.position = new paper.Point(225, 100);
                    svgItem1.rotate(61.00519680642214);
                    svgItem1.scale(5);

                    svgItem2.position=new paper.Point(278, 150);
                    svgItem2.scale(0.2);

                    // Extract paths
                    const paths1 = extractPaths(svgItem1);
                    const paths2 = extractPaths(svgItem2);

                    if (paths1.length === 0 || paths2.length === 0) {
                        throw new Error("No valid paths found in one or both SVG files.");
                    }

                    // Perform the boolean operation on each path
                    let combinedPath = paths1[0];
                    paths1.slice(1).forEach(path => combinedPath = combinedPath.unite(path));
                    paths2.forEach(path => {
                        switch(operation) {
                            case 'union':
                                combinedPath = combinedPath.unite(path);
                                break;
                            case 'difference':
                                combinedPath = combinedPath.subtract(path);
                                break;
                            case 'xor':
                                combinedPath = combinedPath.exclude(path);
                                break;
                            case 'intersection':
                                combinedPath = combinedPath.intersect(path);
                                break;
                            default:
                                throw new Error("Unknown operation");
                        }
                    });

                    // combinedPath.fillColor = null;
                    // combinedPath.strokeColor = 'black';
                    // combinedPath.strokeWidth = 2;

                    shapes.push(combinedPath);

                    // Enable dragging for the combined path
                    combinedPath.onMouseDrag = function(event) {
                        this.position = this.position.add(event.delta);
                    };

                    // Add the combined path to the canvas
                    paper.project.activeLayer.addChild(combinedPath);
                    paper.view.draw();

                    logDetails(`Operation: ${operation}`);
                    logDetails(`Combined Path: ${combinedPath.pathData}`);
                } else {
                    alert("Please provide two SVG files or strings.");
                }
            } catch (error) {
                console.error('Error loading SVG files:', error);
                logDetails(`Error: ${error.message}`);
            }
        };

        // Clear function
        const clearInputs = () => {
            document.getElementById('fileInput1').value = '';
            document.getElementById('fileInput2').value = '';
            document.getElementById('svgString1').value = '';
            document.getElementById('svgString2').value = '';
            document.getElementById('log').innerHTML = '';
            shapes.forEach(shape => shape.remove());
            shapes = [];
            paper.project.clear();
            paper.view.draw();
        };

        document.getElementById('unionButton').onclick = performBooleanOperation('union');
        document.getElementById('differenceButton').onclick = performBooleanOperation('difference');
        document.getElementById('xorButton').onclick = performBooleanOperation('xor');
        document.getElementById('intersectionButton').onclick = performBooleanOperation('intersection');
        document.getElementById('clearButton').onclick = clearInputs;
    </script>
</body>
</html>
