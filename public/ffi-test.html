<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T3000 FFI Test Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #0056b3; }
        .result-box { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .success { border-left: 4px solid #28a745; background-color: #d4edda; }
        .error { border-left: 4px solid #dc3545; background-color: #f8d7da; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #ffc107; }
        input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß T3000 FFI Service Test Interface</h1>

        <div class="test-section">
            <h2>üì° FFI Availability Test</h2>
            <p>Tests if T3000.exe is running and FFI functions are available.</p>
            <button class="test-button" onclick="testFFIAvailability()">Test FFI Availability</button>
            <div id="ffi-availability-result" class="result-box" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üåê Device Connection Test</h2>
            <p>Test connection to a specific T3000 device.</p>
            <label>Device ID: <input type="number" id="device-id" value="1" min="1" max="255"></label>
            <button class="test-button" onclick="testDeviceConnection()">Test Device Connection</button>
            <div id="device-connection-result" class="result-box" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üìã Device Enumeration Test</h2>
            <p>Scans devices 1-10 to find which are online.</p>
            <button class="test-button" onclick="testDeviceEnumeration()">Enumerate Devices</button>
            <div id="device-enumeration-result" class="result-box" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üìä TrendLog FFI Sync Test</h2>
            <p>Test TrendLog data retrieval via FFI for a specific device and monitor.</p>
            <label>Device ID: <input type="number" id="trendlog-device-id" value="1" min="1" max="255"></label>
            <label>Monitor ID: <input type="text" id="trendlog-monitor-id" value="MONITOR1" placeholder="MONITOR1"></label>
            <button class="test-button" onclick="testTrendLogFFI()">Test TrendLog FFI</button>
            <div id="trendlog-ffi-result" class="result-box" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üìù Test Results Summary</h2>
            <div id="summary-results"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3003/api';
        let testResults = [];

        function displayResult(elementId, data, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result-box ${isSuccess ? 'success' : 'error'}`;

            let content = '';
            if (typeof data === 'object') {
                content = JSON.stringify(data, null, 2);
            } else {
                content = data;
            }

            element.textContent = content;
            updateSummary();
        }

        async function testFFIAvailability() {
            try {
                const response = await fetch(`${API_BASE}/t3_device/ffi/test`);
                const responseText = await response.text();

                // Try to parse as JSON, if it fails show the raw response
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // Not JSON, show raw response for debugging
                    testResults['ffi-availability'] = false;
                    displayResult('ffi-availability-result', `Raw Response (${response.status}): ${responseText}`, false);
                    console.error('Response is not JSON:', responseText);
                    return;
                }

                testResults['ffi-availability'] = data.success;
                displayResult('ffi-availability-result', data, data.success);

                if (data.success) {
                    console.log('‚úÖ FFI Availability Test Passed');
                } else {
                    console.log('‚ùå FFI Availability Test Failed');
                }
            } catch (error) {
                testResults['ffi-availability'] = false;
                displayResult('ffi-availability-result', `Network Error: ${error.message}`, false);
                console.error('FFI Availability Test Error:', error);
            }
        }

        async function testDeviceConnection() {
            const deviceId = document.getElementById('device-id').value;

            try {
                const response = await fetch(`${API_BASE}/t3_device/ffi/test/${deviceId}`);
                const responseText = await response.text();

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    testResults[`device-${deviceId}`] = false;
                    displayResult('device-connection-result', `Raw Response (${response.status}): ${responseText}`, false);
                    console.error('Response is not JSON:', responseText);
                    return;
                }

                testResults[`device-${deviceId}`] = data.success;
                displayResult('device-connection-result', data, data.success);

                if (data.success && data.result && data.result.includes('Online')) {
                    console.log(`‚úÖ Device ${deviceId} is online`);
                } else {
                    console.log(`‚ùå Device ${deviceId} is offline or error`);
                }
            } catch (error) {
                testResults[`device-${deviceId}`] = false;
                displayResult('device-connection-result', `Network Error: ${error.message}`, false);
                console.error('Device Connection Test Error:', error);
            }
        }

        async function testDeviceEnumeration() {
            try {
                const response = await fetch(`${API_BASE}/t3_device/ffi/enumerate`);
                const responseText = await response.text();

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    testResults['device-enumeration'] = false;
                    displayResult('device-enumeration-result', `Raw Response (${response.status}): ${responseText}`, false);
                    console.error('Response is not JSON:', responseText);
                    return;
                }

                testResults['device-enumeration'] = data.success;
                displayResult('device-enumeration-result', data, data.success);

                if (data.success) {
                    console.log('‚úÖ Device Enumeration Test Completed');
                } else {
                    console.log('‚ùå Device Enumeration Test Failed');
                }
            } catch (error) {
                testResults['device-enumeration'] = false;
                displayResult('device-enumeration-result', `Network Error: ${error.message}`, false);
                console.error('Device Enumeration Test Error:', error);
            }
        }

        async function testTrendLogFFI() {
            const deviceId = document.getElementById('trendlog-device-id').value;
            const monitorId = document.getElementById('trendlog-monitor-id').value;

            try {
                const response = await fetch(`${API_BASE}/t3_device/sync-ffi/${deviceId}/${monitorId}`, {
                    method: 'POST'
                });
                const responseText = await response.text();

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    testResults['trendlog-ffi'] = false;
                    displayResult('trendlog-ffi-result', `Raw Response (${response.status}): ${responseText}`, false);
                    console.error('Response is not JSON:', responseText);
                    return;
                }

                testResults['trendlog-ffi'] = data.success;
                displayResult('trendlog-ffi-result', data, data.success);

                if (data.success) {
                    console.log(`‚úÖ TrendLog FFI Sync for ${monitorId} completed`);
                } else {
                    console.log(`‚ùå TrendLog FFI Sync for ${monitorId} failed`);
                }
            } catch (error) {
                testResults['trendlog-ffi'] = false;
                displayResult('trendlog-ffi-result', `Network Error: ${error.message}`, false);
                console.error('TrendLog FFI Test Error:', error);
            }
        }

        function updateSummary() {
            const summaryElement = document.getElementById('summary-results');
            let summaryHTML = '';

            for (const [testName, success] in Object.entries(testResults)) {
                const statusClass = success ? 'status-online' : 'status-offline';
                const statusText = success ? 'PASS' : 'FAIL';
                summaryHTML += `<div><span class="status-indicator ${statusClass}"></span>${testName}: ${statusText}</div>`;
            }

            if (summaryHTML) {
                summaryElement.innerHTML = summaryHTML;
            } else {
                summaryElement.innerHTML = '<em>No tests run yet</em>';
            }
        }

        // Initialize summary
        updateSummary();

        // Auto-run FFI availability test on page load
        window.addEventListener('load', () => {
            setTimeout(testFFIAvailability, 1000);
        });
    </script>
</body>
</html>
